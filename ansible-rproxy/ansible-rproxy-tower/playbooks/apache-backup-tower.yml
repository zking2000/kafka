---
- name: Apacheé…ç½®æ–‡ä»¶å¤‡ä»½å¹¶æ¨é€åˆ°Git (Ansible Towerç‰ˆ)
  hosts: rproxy
  gather_facts: yes
  become: yes
  
  vars:
    # Towerå‹å¥½çš„å˜é‡å®šä¹‰
    timestamp: "{{ ansible_date_time.epoch }}"
    zip_filename: "apache-conf-{{ inventory_hostname }}-{{ timestamp }}.zip"
    # Toweræ‰§è¡Œç¯å¢ƒä¸­çš„è·¯å¾„
    tower_backup_dir: "/tmp/tower-backups"
    local_zip_path: "{{ tower_backup_dir }}/{{ zip_filename }}"
    local_extract_path: "{{ tower_backup_dir }}/extracted/{{ inventory_hostname }}"
    tower_git_work_dir: "{{ tower_backup_dir }}/git-work/{{ inventory_hostname }}"
    tower_git_repo_dir: "{{ tower_git_work_dir }}/repo"
    
  pre_tasks:
    - name: éªŒè¯Towerå¿…è¦å˜é‡æ˜¯å¦å·²å®šä¹‰
      assert:
        that:
          - backup_dir is defined
          - tower_github_repo is defined
          - tower_github_token is defined
          - tower_git_user_name is defined
          - tower_git_user_email is defined
        fail_msg: "å¿…è¦çš„å˜é‡æœªå®šä¹‰ï¼Œè¯·åœ¨Tower Job Templateçš„Extra Variablesä¸­é…ç½®ç›¸å…³å˜é‡"

    - name: æ˜¾ç¤ºTowerä»»åŠ¡å¼€å§‹ä¿¡æ¯
      debug:
        msg: |
          ğŸš€ å¼€å§‹Apacheé…ç½®å¤‡ä»½å’ŒGitæ¨é€ä»»åŠ¡ (Toweræ‰§è¡Œ)
          - Tower Job ID: {{ tower_job_id | default('N/A') }}
          - Towerç”¨æˆ·: {{ tower_user_name | default('N/A') }}
          - ç›®æ ‡ä¸»æœº: {{ inventory_hostname }} ({{ ansible_host }})
          - å¤‡ä»½ç›®å½•: {{ backup_dir }}
          - Towerå¤‡ä»½ç›®å½•: {{ tower_backup_dir }}
          - GitHubä»“åº“: {{ tower_github_repo }}
          - ç›®æ ‡åˆ†æ”¯: {{ tower_github_branch | default('main') }}

    - name: ç¡®ä¿Towerå·¥ä½œç›®å½•å­˜åœ¨
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true
      loop:
        - "{{ tower_backup_dir }}"
        - "{{ tower_git_work_dir }}"
      tags: ['preparation']

  tasks:
    # ========== è¿œç¨‹å¤‡ä»½æ“ä½œ ==========
    - name: æ£€æŸ¥è¿œç¨‹httpdé…ç½®ç›®å½•
      stat:
        path: /etc/httpd/conf
      register: httpd_conf_dir
      tags: ['validation']

    - name: éªŒè¯Apacheé…ç½®ç›®å½•å­˜åœ¨
      assert:
        that:
          - httpd_conf_dir.stat.exists
          - httpd_conf_dir.stat.isdir
        fail_msg: "Apache httpdé…ç½®ç›®å½• /etc/httpd/conf ä¸å­˜åœ¨æˆ–ä¸æ˜¯ç›®å½•"
      tags: ['validation']

    - name: æ£€æŸ¥SELinuxçŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      command: getenforce
      register: selinux_status
      failed_when: false
      changed_when: false
      tags: ['system-info']

    - name: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
      debug:
        msg: |
          ğŸ“Š ç³»ç»Ÿä¿¡æ¯:
          - OS: {{ ansible_os_family }} {{ ansible_distribution_version }}
          - SELinux: {{ selinux_status.stdout | default('æœªå¯ç”¨') }}
          - Python: {{ ansible_python_version }}
          - Toweræ‰§è¡ŒèŠ‚ç‚¹: {{ ansible_hostname }}
      tags: ['system-info']

    - name: ç¡®ä¿è¿œç¨‹å¤‡ä»½ç›®å½•å­˜åœ¨
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      tags: ['preparation']

    - name: å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…ï¼ˆä»…zip/unzipï¼Œä¸å®‰è£…gitï¼‰
      package:
        name: 
          - zip
          - unzip
        state: present
      tags: ['preparation']

    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      shell: df -h {{ backup_dir }} | tail -1 | awk '{print $4}'
      register: available_space
      changed_when: false
      tags: ['validation']

    - name: æ˜¾ç¤ºå¯ç”¨ç£ç›˜ç©ºé—´
      debug:
        msg: "ğŸ“ å¤‡ä»½ç›®å½•å¯ç”¨ç©ºé—´: {{ available_space.stdout }}"
      tags: ['validation']

    - name: åˆ›å»ºApacheé…ç½®æ–‡ä»¶çš„zipåŒ…
      archive:
        path: /etc/httpd/conf
        dest: "{{ backup_dir }}/{{ zip_filename }}"
        format: zip
        mode: '0644'
        owner: root
        group: root
      register: zip_result
      tags: ['backup']

    - name: éªŒè¯zipæ–‡ä»¶åˆ›å»ºæˆåŠŸ
      stat:
        path: "{{ backup_dir }}/{{ zip_filename }}"
      register: zip_file_stat
      tags: ['validation']

    - name: ç¡®ä¿zipæ–‡ä»¶åˆ›å»ºæˆåŠŸ
      assert:
        that:
          - zip_file_stat.stat.exists
          - zip_file_stat.stat.size > 0
        fail_msg: "ZIPæ–‡ä»¶åˆ›å»ºå¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º: {{ backup_dir }}/{{ zip_filename }}"
      tags: ['validation']

    - name: æ˜¾ç¤ºzipæ–‡ä»¶ä¿¡æ¯
      debug:
        msg: |
          ğŸ“¦ å¤‡ä»½æ–‡ä»¶ä¿¡æ¯:
          - æ–‡ä»¶è·¯å¾„: {{ backup_dir }}/{{ zip_filename }}
          - æ–‡ä»¶å¤§å°: {{ zip_file_stat.stat.size }} bytes
          - åˆ›å»ºæ—¶é—´: {{ zip_file_stat.stat.mtime }}
      tags: ['backup']

    # ========== Toweræœ¬åœ°ä¸‹è½½å’Œå¤„ç† ==========
    - name: ä¸‹è½½zipæ–‡ä»¶åˆ°Toweræ‰§è¡ŒèŠ‚ç‚¹
      fetch:
        src: "{{ backup_dir }}/{{ zip_filename }}"
        dest: "{{ local_zip_path }}"
        flat: yes
        validate_checksum: yes
      register: fetch_result
      tags: ['download']

    - name: éªŒè¯æ–‡ä»¶ä¸‹è½½åˆ°ToweræˆåŠŸ
      stat:
        path: "{{ local_zip_path }}"
      register: local_zip_stat
      delegate_to: localhost
      tags: ['validation']

    - name: ç¡®ä¿Toweræœ¬åœ°æ–‡ä»¶ä¸‹è½½æˆåŠŸ
      assert:
        that:
          - local_zip_stat.stat.exists
          - local_zip_stat.stat.size > 0
        fail_msg: "Toweræœ¬åœ°ZIPæ–‡ä»¶ä¸‹è½½å¤±è´¥: {{ local_zip_path }}"
      delegate_to: localhost
      tags: ['validation']

    - name: æ¸…ç†è¿œç¨‹ä¸´æ—¶æ–‡ä»¶
      file:
        path: "{{ backup_dir }}/{{ zip_filename }}"
        state: absent
      tags: ['cleanup']

    - name: ç¡®ä¿Towerè§£å‹ç›®å½•å­˜åœ¨
      file:
        path: "{{ local_extract_path }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      tags: ['preparation']

    - name: åœ¨Toweræ‰§è¡ŒèŠ‚ç‚¹è§£å‹zipæ–‡ä»¶
      unarchive:
        src: "{{ local_zip_path }}"
        dest: "{{ local_extract_path }}"
        remote_src: no
      delegate_to: localhost
      tags: ['extract']

    - name: éªŒè¯Towerè§£å‹æˆåŠŸ
      find:
        paths: "{{ local_extract_path }}"
        recurse: yes
      register: extracted_files
      delegate_to: localhost
      tags: ['validation']

    - name: ç¡®ä¿Towerè§£å‹æˆåŠŸ
      assert:
        that:
          - extracted_files.matched > 0
        fail_msg: "æ–‡ä»¶è§£å‹å¤±è´¥ï¼Œæ²¡æœ‰æ‰¾åˆ°è§£å‹çš„æ–‡ä»¶"
      delegate_to: localhost
      tags: ['validation']

    # ========== Tower Gitæ“ä½œ ==========
    - name: åœ¨Toweræ‰§è¡ŒèŠ‚ç‚¹å…‹éš†æˆ–æ›´æ–°GitHubä»“åº“
      git:
        repo: "https://{{ tower_github_token }}@github.com/{{ tower_github_repo }}.git"
        dest: "{{ tower_git_repo_dir }}"
        force: yes
        version: "{{ tower_github_branch | default('main') }}"
      delegate_to: localhost
      environment:
        GIT_TERMINAL_PROMPT: '0'
      no_log: true  # éšè—åŒ…å«tokençš„æ—¥å¿—
      tags: ['git']

    - name: åœ¨Toweræ‰§è¡ŒèŠ‚ç‚¹é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      git_config:
        name: "{{ item.name }}"
        scope: local
        value: "{{ item.value }}"
        repo: "{{ tower_git_repo_dir }}"
      delegate_to: localhost
      loop:
        - { name: "user.name", value: "{{ tower_git_user_name }}" }
        - { name: "user.email", value: "{{ tower_git_user_email }}" }
      tags: ['git']

    - name: ç¡®ä¿Gitä»“åº“ä¸­çš„ä¸»æœºç›®å½•å­˜åœ¨
      file:
        path: "{{ tower_git_repo_dir }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      tags: ['git']

    - name: åŒæ­¥å¤‡ä»½æ–‡ä»¶åˆ°Gitä»“åº“
      synchronize:
        src: "{{ local_extract_path }}/conf/"
        dest: "{{ tower_git_repo_dir }}/{{ inventory_hostname }}/"
        delete: yes
        recursive: yes
      delegate_to: localhost
      tags: ['git']

    - name: åˆ›å»ºTowerå¤‡ä»½å…ƒæ•°æ®æ–‡ä»¶
      copy:
        content: |
          # Apacheé…ç½®å¤‡ä»½å…ƒæ•°æ® (Ansible Tower)
          å¤‡ä»½æ—¶é—´: {{ ansible_date_time.iso8601 }}
          æºä¸»æœº: {{ inventory_hostname }}
          æºIP: {{ ansible_host }}
          å¤‡ä»½ç”¨æˆ·: {{ ansible_user }}
          ç³»ç»Ÿä¿¡æ¯: {{ ansible_os_family }} {{ ansible_distribution_version }}
          å¤‡ä»½æ–‡ä»¶: {{ zip_filename }}
          æ–‡ä»¶å¤§å°: {{ zip_file_stat.stat.size }} bytes
          Ansibleç‰ˆæœ¬: {{ ansible_version.full }}
          æ‰§è¡Œæ–¹å¼: Ansible Tower
          Tower Job ID: {{ tower_job_id | default('N/A') }}
          Towerç”¨æˆ·: {{ tower_user_name | default('N/A') }}
          Gitåˆ†æ”¯: {{ tower_github_branch | default('main') }}
          æ‰§è¡ŒèŠ‚ç‚¹: {{ ansible_hostname }}
        dest: "{{ tower_git_repo_dir }}/{{ inventory_hostname }}/backup_metadata.txt"
      delegate_to: localhost
      tags: ['git', 'metadata']

    - name: æ£€æŸ¥Gitä»“åº“æ˜¯å¦æœ‰å˜æ›´
      shell: |
        cd "{{ tower_git_repo_dir }}"
        git add .
        git diff --cached --name-only
      register: git_changes
      delegate_to: localhost
      changed_when: false
      tags: ['git']

    - name: æäº¤å˜æ›´åˆ°Gitä»“åº“
      shell: |
        cd "{{ tower_git_repo_dir }}"
        git add .
        git commit -m "è‡ªåŠ¨å¤‡ä»½Apacheé…ç½® - {{ inventory_hostname }} - {{ ansible_date_time.iso8601 }} (Tower Job: {{ tower_job_id | default('N/A') }})"
      delegate_to: localhost
      when: git_changes.stdout_lines | length > 0
      register: git_commit
      tags: ['git']

    - name: æ¨é€å˜æ›´åˆ°GitHub
      shell: |
        cd "{{ tower_git_repo_dir }}"
        git push origin {{ tower_github_branch | default('main') }}
      delegate_to: localhost
      when: git_commit is changed
      environment:
        GIT_TERMINAL_PROMPT: '0'
      no_log: true  # éšè—åŒ…å«tokençš„è¾“å‡º
      tags: ['git']

  post_tasks:
    - name: æ˜¾ç¤ºTowerä»»åŠ¡å®Œæˆä¿¡æ¯
      debug:
        msg: |
          âœ… Towerå¤‡ä»½å’ŒGitæ¨é€ä»»åŠ¡å®Œæˆï¼
          ğŸ“‹ æ‘˜è¦ä¿¡æ¯:
          - Tower Job ID: {{ tower_job_id | default('N/A') }}
          - Towerç”¨æˆ·: {{ tower_user_name | default('N/A') }}
          - ä¸»æœº: {{ inventory_hostname }} ({{ ansible_host }})
          - å¤‡ä»½æ–‡ä»¶: {{ zip_filename }}
          - Towerè§£å‹è·¯å¾„: {{ local_extract_path }}
          - Gitä»“åº“è·¯å¾„: {{ tower_git_repo_dir }}
          - GitHubä»“åº“: {{ tower_github_repo }}
          - Gitåˆ†æ”¯: {{ tower_github_branch | default('main') }}
          - å¤‡ä»½æ—¶é—´: {{ ansible_date_time.iso8601 }}
          - æ–‡ä»¶æ•°é‡: {{ extracted_files.matched }}
          {% if git_changes.stdout_lines | length > 0 %}
          - Gitå˜æ›´: {{ git_changes.stdout_lines | length }} ä¸ªæ–‡ä»¶
          - Gitæ¨é€: âœ… æˆåŠŸ
          {% else %}
          - Gitå˜æ›´: æ— å˜æ›´ï¼Œè·³è¿‡æ¨é€
          {% endif %}
          
          ğŸ“ Toweræ–‡ä»¶ä½ç½®:
          - Tower ZIP: {{ local_zip_path }}
          - è§£å‹ç›®å½•: {{ local_extract_path }}
          - Gitä»“åº“: {{ tower_git_repo_dir }}

    - name: Toweræ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
      file:
        path: "{{ item }}"
        state: absent
      delegate_to: localhost
      loop:
        - "{{ local_zip_path }}"
        # - "{{ local_extract_path }}"  # ä¿ç•™è§£å‹æ–‡ä»¶ä»¥ä¾›Toweræ£€æŸ¥
        # - "{{ tower_git_work_dir }}"  # ä¿ç•™Gitå·¥ä½œç›®å½•ä»¥ä¾›Toweræ£€æŸ¥
      when: tower_cleanup_temp_files | default(false) | bool
      tags: ['cleanup']

    - name: å‘é€Toweré€šçŸ¥ï¼ˆå¦‚æœé…ç½®äº†é€šçŸ¥ï¼‰
      debug:
        msg: |
          ğŸ“§ Toweré€šçŸ¥ä¿¡æ¯:
          - ä»»åŠ¡çŠ¶æ€: æˆåŠŸå®Œæˆ
          - ä¸»æœº: {{ inventory_hostname }}
          - å¤‡ä»½æ—¶é—´: {{ ansible_date_time.iso8601 }}
          - Job ID: {{ tower_job_id | default('N/A') }}
      when: tower_send_notifications | default(false) | bool
      tags: ['notification']

  handlers:
    - name: Toweræ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ backup_dir }}/{{ zip_filename }}"
        - "{{ local_zip_path }}"
      listen: "tower cleanup on failure"
      ignore_errors: yes 