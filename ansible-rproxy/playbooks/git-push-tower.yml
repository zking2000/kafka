---
- name: Gitæ¨é€å¤‡ä»½æ–‡ä»¶åˆ°GitHub (Ansible Towerä¼˜åŒ–ç‰ˆ)
  hosts: localhost
  gather_facts: yes
  connection: local
  become: no
  
  vars:
    # Towerä¸­é…ç½®çš„é¡¹ç›®è·¯å¾„
    project_path: "{{ tower_project_path | default('/tmp/tower-projects') }}"
    backup_source_path: "/tmp/extracted"
    timestamp: "{{ ansible_date_time.epoch }}"
    
  pre_tasks:
    - name: éªŒè¯å¿…è¦å˜é‡æ˜¯å¦å·²å®šä¹‰
      assert:
        that:
          - github_repo is defined
          - github_token is defined
          - git_user_name is defined
          - git_user_email is defined
        fail_msg: "å¿…è¦çš„å˜é‡æœªå®šä¹‰ï¼Œè¯·åœ¨Towerä¸­é…ç½®: github_repo, github_token, git_user_name, git_user_email"

    - name: æ˜¾ç¤ºGitæ¨é€ä»»åŠ¡å¼€å§‹ä¿¡æ¯
      debug:
        msg: |
          ğŸ”„ å¼€å§‹Gitæ¨é€ä»»åŠ¡
          - GitHubä»“åº“: {{ github_repo }}
          - æºè·¯å¾„: {{ backup_source_path }}
          - é¡¹ç›®è·¯å¾„: {{ project_path }}

  tasks:
    - name: æ£€æŸ¥å¤‡ä»½æºç›®å½•æ˜¯å¦å­˜åœ¨
      stat:
        path: "{{ backup_source_path }}"
      register: source_stat

    - name: ç¡®ä¿å¤‡ä»½æºç›®å½•å­˜åœ¨
      assert:
        that:
          - source_stat.stat.exists
          - source_stat.stat.isdir
        fail_msg: "å¤‡ä»½æºç›®å½•ä¸å­˜åœ¨: {{ backup_source_path }}"

    - name: æ‰«ææ‰€æœ‰ä¸»æœºå¤‡ä»½ç›®å½•
      find:
        paths: "{{ backup_source_path }}"
        file_type: directory
        depth: 1
      register: host_dirs

    - name: æ˜¾ç¤ºå‘ç°çš„ä¸»æœºå¤‡ä»½
      debug:
        msg: |
          ğŸ“ å‘ç°çš„ä¸»æœºå¤‡ä»½:
          {% for dir in host_dirs.files %}
          - {{ dir.path | basename }}
          {% endfor %}

    - name: å¤„ç†æ¯ä¸ªä¸»æœºçš„å¤‡ä»½æ–‡ä»¶
      include_tasks: tasks/process-host-backup.yml
      vars:
        host_name: "{{ item.path | basename }}"
        host_backup_path: "{{ item.path }}"
      loop: "{{ host_dirs.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

  handlers:
    - name: æ¸…ç†å·¥ä½œç›®å½•
      file:
        path: "{{ project_path }}/{{ github_repo.split('/')[-1] }}"
        state: absent
      listen: "cleanup git workspace"
      ignore_errors: yes 