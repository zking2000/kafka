---
- name: å®Œæ•´Apacheé…ç½®å¤‡ä»½æµç¨‹ (Ansible Towerä¼˜åŒ–ç‰ˆ)
  hosts: rproxy
  gather_facts: yes
  become: yes
  serial: "{{ backup_serial | default(1) }}"  # æ”¯æŒå¹¶è¡Œæ‰§è¡Œæ§åˆ¶
  
  vars:
    timestamp: "{{ ansible_date_time.epoch }}"
    zip_filename: "apache-conf-{{ inventory_hostname }}-{{ timestamp }}.zip"
    local_zip_path: "/tmp/{{ zip_filename }}"
    local_extract_path: "/tmp/extracted/{{ inventory_hostname }}"
    
  pre_tasks:
    - name: éªŒè¯å¿…è¦å˜é‡æ˜¯å¦å·²å®šä¹‰
      assert:
        that:
          - github_repo is defined
          - github_token is defined
          - backup_dir is defined
          - git_user_name is defined
          - git_user_email is defined
        fail_msg: "å¿…è¦çš„å˜é‡æœªå®šä¹‰ï¼Œè¯·åœ¨Towerä¸­é…ç½®æ‰€æœ‰å¿…éœ€å˜é‡"

    - name: æ˜¾ç¤ºä»»åŠ¡å¼€å§‹ä¿¡æ¯
      debug:
        msg: |
          ğŸš€ å¼€å§‹å®Œæ•´Apacheé…ç½®å¤‡ä»½æµç¨‹
          - ç›®æ ‡ä¸»æœº: {{ inventory_hostname }} ({{ ansible_host }})
          - å¤‡ä»½ç›®å½•: {{ backup_dir }}
          - GitHubä»“åº“: {{ github_repo }}
          - ç›®æ ‡åˆ†æ”¯: {{ github_branch | default('main') }}
          - æ‰§è¡Œæ¨¡å¼: {{ 'Serial' if backup_serial == 1 else 'Parallel (' + backup_serial|string + ')' }}

  tasks:
    # é˜¶æ®µ1: å¤‡ä»½éªŒè¯
    - name: æ£€æŸ¥è¿œç¨‹httpdé…ç½®ç›®å½•
      stat:
        path: /etc/httpd/conf
      register: httpd_conf_dir
      tags: ['validation', 'backup']

    - name: éªŒè¯Apacheé…ç½®ç›®å½•å­˜åœ¨
      assert:
        that:
          - httpd_conf_dir.stat.exists
          - httpd_conf_dir.stat.isdir
        fail_msg: "Apache httpdé…ç½®ç›®å½• /etc/httpd/conf ä¸å­˜åœ¨æˆ–ä¸æ˜¯ç›®å½•"
      tags: ['validation', 'backup']

    # é˜¶æ®µ2: ç³»ç»Ÿå‡†å¤‡
    - name: ç¡®ä¿è¿œç¨‹å¤‡ä»½ç›®å½•å­˜åœ¨
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      tags: ['preparation', 'backup']

    - name: å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…
      package:
        name: 
          - zip
          - unzip
        state: present
      tags: ['preparation', 'backup']

    # é˜¶æ®µ3: åˆ›å»ºå¤‡ä»½
    - name: åˆ›å»ºApacheé…ç½®æ–‡ä»¶çš„zipåŒ…
      archive:
        path: /etc/httpd/conf
        dest: "{{ backup_dir }}/{{ zip_filename }}"
        format: zip
        mode: '0644'
        owner: root
        group: root
      register: zip_result
      tags: ['backup']

    - name: éªŒè¯zipæ–‡ä»¶åˆ›å»ºæˆåŠŸ
      stat:
        path: "{{ backup_dir }}/{{ zip_filename }}"
      register: zip_file_stat
      tags: ['validation', 'backup']

    - name: ç¡®ä¿zipæ–‡ä»¶åˆ›å»ºæˆåŠŸ
      assert:
        that:
          - zip_file_stat.stat.exists
          - zip_file_stat.stat.size > 0
        fail_msg: "ZIPæ–‡ä»¶åˆ›å»ºå¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º: {{ backup_dir }}/{{ zip_filename }}"
      tags: ['validation', 'backup']

    # é˜¶æ®µ4: ä¸‹è½½å’Œè§£å‹
    - name: ä¸‹è½½zipæ–‡ä»¶åˆ°Toweræ‰§è¡ŒèŠ‚ç‚¹
      fetch:
        src: "{{ backup_dir }}/{{ zip_filename }}"
        dest: "{{ local_zip_path }}"
        flat: yes
        validate_checksum: yes
      register: fetch_result
      tags: ['download', 'backup']

    - name: æ¸…ç†è¿œç¨‹ä¸´æ—¶æ–‡ä»¶
      file:
        path: "{{ backup_dir }}/{{ zip_filename }}"
        state: absent
      tags: ['cleanup', 'backup']

    - name: ç¡®ä¿æœ¬åœ°è§£å‹ç›®å½•å­˜åœ¨
      file:
        path: "{{ local_extract_path }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      tags: ['preparation', 'extract']

    - name: è§£å‹zipæ–‡ä»¶åˆ°æœ¬åœ°ç›®å½•
      unarchive:
        src: "{{ local_zip_path }}"
        dest: "{{ local_extract_path }}"
        remote_src: no
      delegate_to: localhost
      tags: ['extract']

    - name: éªŒè¯è§£å‹æˆåŠŸ
      find:
        paths: "{{ local_extract_path }}"
        recurse: yes
      register: extracted_files
      delegate_to: localhost
      tags: ['validation', 'extract']

    - name: åˆ›å»ºå¤‡ä»½å…ƒæ•°æ®
      copy:
        content: |
          # Apacheé…ç½®å¤‡ä»½å…ƒæ•°æ®
          å¤‡ä»½æ—¶é—´: {{ ansible_date_time.iso8601 }}
          æºä¸»æœº: {{ inventory_hostname }}
          æºIP: {{ ansible_host }}
          å¤‡ä»½ç”¨æˆ·: {{ ansible_user }}
          ç³»ç»Ÿä¿¡æ¯: {{ ansible_os_family }} {{ ansible_distribution_version }}
          å¤‡ä»½æ–‡ä»¶: {{ zip_filename }}
          æ–‡ä»¶å¤§å°: {{ zip_file_stat.stat.size }} bytes
          æ–‡ä»¶æ•°é‡: {{ extracted_files.matched }}
          Ansibleç‰ˆæœ¬: {{ ansible_version.full }}
          Towerä»»åŠ¡ID: {{ tower_job_id | default('N/A') }}
          GitHubåˆ†æ”¯: {{ github_branch | default('main') }}
        dest: "{{ local_extract_path }}/backup_metadata.txt"
      delegate_to: localhost
      tags: ['metadata', 'extract']

    - name: æ¸…ç†æœ¬åœ°ä¸´æ—¶zipæ–‡ä»¶
      file:
        path: "{{ local_zip_path }}"
        state: absent
      delegate_to: localhost
      tags: ['cleanup', 'extract']

    - name: æ˜¾ç¤ºå¤‡ä»½é˜¶æ®µå®Œæˆä¿¡æ¯
      debug:
        msg: |
          âœ… {{ inventory_hostname }} å¤‡ä»½é˜¶æ®µå®Œæˆï¼
          ğŸ“¦ å¤‡ä»½ä¿¡æ¯:
          - æ–‡ä»¶æ•°é‡: {{ extracted_files.matched }}
          - æ–‡ä»¶å¤§å°: {{ zip_file_stat.stat.size }} bytes
          - æœ¬åœ°è·¯å¾„: {{ local_extract_path }}
      tags: ['backup']

# ç¬¬äºŒä¸ªplay: Gitæ¨é€ (åªåœ¨localhostæ‰§è¡Œ)
- name: æ¨é€æ‰€æœ‰å¤‡ä»½åˆ°GitHub
  hosts: localhost
  gather_facts: no
  connection: local
  become: no
  
  vars:
    project_path: "{{ tower_project_path | default('/tmp/tower-projects') }}"
    backup_source_path: "/tmp/extracted"
    
  tasks:
    - name: æ‰«ææ‰€æœ‰ä¸»æœºå¤‡ä»½ç›®å½•
      find:
        paths: "{{ backup_source_path }}"
        file_type: directory
        depth: 1
      register: host_dirs
      tags: ['git', 'scan']

    - name: æ˜¾ç¤ºå‘ç°çš„ä¸»æœºå¤‡ä»½
      debug:
        msg: |
          ğŸ“ å‘ç°çš„ä¸»æœºå¤‡ä»½ ({{ host_dirs.files | length }} ä¸ª):
          {% for dir in host_dirs.files %}
          - {{ dir.path | basename }}
          {% endfor %}
      tags: ['git', 'scan']

    - name: ç¡®ä¿æœ‰å¤‡ä»½æ–‡ä»¶éœ€è¦æ¨é€
      assert:
        that:
          - host_dirs.files | length > 0
        fail_msg: "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¤‡ä»½æ–‡ä»¶éœ€è¦æ¨é€"
      tags: ['validation', 'git']

    - name: ä¸ºæ¯ä¸ªä¸»æœºæ¨é€å¤‡ä»½åˆ°GitHub
      include_tasks: tasks/process-host-backup.yml
      vars:
        host_name: "{{ item.path | basename }}"
        host_backup_path: "{{ item.path }}"
      loop: "{{ host_dirs.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
      tags: ['git', 'push']

    - name: æ¸…ç†æ‰€æœ‰å¤‡ä»½ç›®å½•
      file:
        path: "{{ backup_source_path }}"
        state: absent
      tags: ['cleanup', 'git']
      when: cleanup_after_push | default(true) | bool

  post_tasks:
    - name: æ˜¾ç¤ºå®Œæ•´æµç¨‹å®Œæˆä¿¡æ¯
      debug:
        msg: |
          ğŸ‰ å®Œæ•´Apacheé…ç½®å¤‡ä»½æµç¨‹å·²å®Œæˆï¼
          
          ğŸ“Š æ‰§è¡Œæ‘˜è¦:
          - å¤„ç†ä¸»æœºæ•°é‡: {{ host_dirs.files | length }}
          - GitHubä»“åº“: {{ github_repo }}
          - æ‰§è¡Œæ—¶é—´: {{ ansible_date_time.iso8601 }}
          - Towerä»»åŠ¡ID: {{ tower_job_id | default('N/A') }}
          
          âœ… æ‰€æœ‰å¤‡ä»½å·²æˆåŠŸæ¨é€åˆ°GitHubå¯¹åº”åˆ†æ”¯
      tags: ['summary'] 