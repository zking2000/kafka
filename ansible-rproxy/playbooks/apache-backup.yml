---
- name: Apacheé…ç½®æ–‡ä»¶å¤‡ä»½å¹¶æ¨é€åˆ°Git (ä»£ç†è¿æ¥ç‰ˆ)
  hosts: rproxy
  gather_facts: yes
  become: yes
  
  vars:
    # æœ¬åœ°æ‰§è¡Œçš„å˜é‡å®šä¹‰
    timestamp: "{{ ansible_date_time.epoch }}"
    zip_filename: "apache-conf-{{ inventory_hostname }}-{{ timestamp }}.zip"
    # æœ¬åœ°è·¯å¾„é…ç½®
    local_backup_dir: "./backups"
    local_zip_path: "{{ local_backup_dir }}/{{ zip_filename }}"
    local_extract_path: "{{ local_backup_dir }}/extracted/{{ inventory_hostname }}"
    local_git_work_dir: "{{ local_backup_dir }}/git-work/{{ inventory_hostname }}"
    local_git_repo_dir: "{{ local_git_work_dir }}/repo"
    
  pre_tasks:
    - name: éªŒè¯å¿…è¦å˜é‡æ˜¯å¦å·²å®šä¹‰
      assert:
        that:
          - backup_dir is defined
          - github_repo is defined
          - github_token is defined
          - git_user_name is defined
          - git_user_email is defined
        fail_msg: "å¿…è¦çš„å˜é‡æœªå®šä¹‰ï¼Œè¯·åœ¨inventoryä¸­é…ç½®: backup_dir, github_repo, github_token, git_user_name, git_user_email"

    - name: æ˜¾ç¤ºä»»åŠ¡å¼€å§‹ä¿¡æ¯
      debug:
        msg: |
          ğŸš€ å¼€å§‹Apacheé…ç½®å¤‡ä»½å’ŒGitæ¨é€ä»»åŠ¡
          - ç›®æ ‡ä¸»æœº: {{ inventory_hostname }} ({{ ansible_host }})
          - å¤‡ä»½ç›®å½•: {{ backup_dir }}
          - æœ¬åœ°å¤‡ä»½ç›®å½•: {{ local_backup_dir }}
          - GitHubä»“åº“: {{ github_repo }}
          - ç›®æ ‡åˆ†æ”¯: {{ github_branch | default('main') }}

    - name: ç¡®ä¿æœ¬åœ°å·¥ä½œç›®å½•å­˜åœ¨
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true
      loop:
        - "{{ local_backup_dir }}"
        - "{{ local_git_work_dir }}"
      tags: ['preparation']

  tasks:
    # ========== è¿œç¨‹å¤‡ä»½æ“ä½œ ==========
    - name: æ£€æŸ¥è¿œç¨‹httpdé…ç½®ç›®å½•
      stat:
        path: /etc/httpd/conf
      register: httpd_conf_dir
      tags: ['validation']

    - name: éªŒè¯Apacheé…ç½®ç›®å½•å­˜åœ¨
      assert:
        that:
          - httpd_conf_dir.stat.exists
          - httpd_conf_dir.stat.isdir
        fail_msg: "Apache httpdé…ç½®ç›®å½• /etc/httpd/conf ä¸å­˜åœ¨æˆ–ä¸æ˜¯ç›®å½•"
      tags: ['validation']

    - name: æ£€æŸ¥SELinuxçŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      command: getenforce
      register: selinux_status
      failed_when: false
      changed_when: false
      tags: ['system-info']

    - name: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
      debug:
        msg: |
          ğŸ“Š ç³»ç»Ÿä¿¡æ¯:
          - OS: {{ ansible_os_family }} {{ ansible_distribution_version }}
          - SELinux: {{ selinux_status.stdout | default('æœªå¯ç”¨') }}
          - Python: {{ ansible_python_version }}
      tags: ['system-info']

    - name: ç¡®ä¿è¿œç¨‹å¤‡ä»½ç›®å½•å­˜åœ¨
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      tags: ['preparation']

    - name: å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…ï¼ˆä»…zip/unzipï¼Œä¸å®‰è£…gitï¼‰
      package:
        name: 
          - zip
          - unzip
        state: present
      tags: ['preparation']

    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      shell: df -h {{ backup_dir }} | tail -1 | awk '{print $4}'
      register: available_space
      changed_when: false
      tags: ['validation']

    - name: æ˜¾ç¤ºå¯ç”¨ç£ç›˜ç©ºé—´
      debug:
        msg: "ğŸ“ å¤‡ä»½ç›®å½•å¯ç”¨ç©ºé—´: {{ available_space.stdout }}"
      tags: ['validation']

    - name: åˆ›å»ºApacheé…ç½®æ–‡ä»¶çš„zipåŒ…
      archive:
        path: /etc/httpd/conf
        dest: "{{ backup_dir }}/{{ zip_filename }}"
        format: zip
        mode: '0644'
        owner: root
        group: root
      register: zip_result
      tags: ['backup']

    - name: éªŒè¯zipæ–‡ä»¶åˆ›å»ºæˆåŠŸ
      stat:
        path: "{{ backup_dir }}/{{ zip_filename }}"
      register: zip_file_stat
      tags: ['validation']

    - name: ç¡®ä¿zipæ–‡ä»¶åˆ›å»ºæˆåŠŸ
      assert:
        that:
          - zip_file_stat.stat.exists
          - zip_file_stat.stat.size > 0
        fail_msg: "ZIPæ–‡ä»¶åˆ›å»ºå¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º: {{ backup_dir }}/{{ zip_filename }}"
      tags: ['validation']

    - name: æ˜¾ç¤ºzipæ–‡ä»¶ä¿¡æ¯
      debug:
        msg: |
          ğŸ“¦ å¤‡ä»½æ–‡ä»¶ä¿¡æ¯:
          - æ–‡ä»¶è·¯å¾„: {{ backup_dir }}/{{ zip_filename }}
          - æ–‡ä»¶å¤§å°: {{ zip_file_stat.stat.size }} bytes
          - åˆ›å»ºæ—¶é—´: {{ zip_file_stat.stat.mtime }}
      tags: ['backup']

    # ========== æœ¬åœ°ä¸‹è½½å’Œå¤„ç† ==========
    - name: ä¸‹è½½zipæ–‡ä»¶åˆ°æœ¬åœ°
      fetch:
        src: "{{ backup_dir }}/{{ zip_filename }}"
        dest: "{{ local_zip_path }}"
        flat: yes
        validate_checksum: yes
      register: fetch_result
      tags: ['download']

    - name: éªŒè¯æ–‡ä»¶ä¸‹è½½æˆåŠŸ
      stat:
        path: "{{ local_zip_path }}"
      register: local_zip_stat
      delegate_to: localhost
      tags: ['validation']

    - name: ç¡®ä¿æœ¬åœ°æ–‡ä»¶ä¸‹è½½æˆåŠŸ
      assert:
        that:
          - local_zip_stat.stat.exists
          - local_zip_stat.stat.size > 0
        fail_msg: "æœ¬åœ°ZIPæ–‡ä»¶ä¸‹è½½å¤±è´¥: {{ local_zip_path }}"
      delegate_to: localhost
      tags: ['validation']

    - name: æ¸…ç†è¿œç¨‹ä¸´æ—¶æ–‡ä»¶
      file:
        path: "{{ backup_dir }}/{{ zip_filename }}"
        state: absent
      tags: ['cleanup']

    - name: ç¡®ä¿æœ¬åœ°è§£å‹ç›®å½•å­˜åœ¨
      file:
        path: "{{ local_extract_path }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      tags: ['preparation']

    - name: è§£å‹zipæ–‡ä»¶åˆ°æœ¬åœ°ç›®å½•
      unarchive:
        src: "{{ local_zip_path }}"
        dest: "{{ local_extract_path }}"
        remote_src: no
      delegate_to: localhost
      tags: ['extract']

    - name: éªŒè¯è§£å‹æˆåŠŸ
      find:
        paths: "{{ local_extract_path }}"
        recurse: yes
      register: extracted_files
      delegate_to: localhost
      tags: ['validation']

    - name: ç¡®ä¿è§£å‹æˆåŠŸ
      assert:
        that:
          - extracted_files.matched > 0
        fail_msg: "æ–‡ä»¶è§£å‹å¤±è´¥ï¼Œæ²¡æœ‰æ‰¾åˆ°è§£å‹çš„æ–‡ä»¶"
      delegate_to: localhost
      tags: ['validation']

    # ========== æœ¬åœ°Gitæ“ä½œ ==========
    - name: å…‹éš†æˆ–æ›´æ–°GitHubä»“åº“åˆ°æœ¬åœ°
      git:
        repo: "https://{{ github_token }}@github.com/{{ github_repo }}.git"
        dest: "{{ local_git_repo_dir }}"
        force: yes
        version: "{{ github_branch | default('main') }}"
      delegate_to: localhost
      environment:
        GIT_TERMINAL_PROMPT: '0'
      no_log: true  # éšè—åŒ…å«tokençš„æ—¥å¿—
      tags: ['git']

    - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
      git_config:
        name: "{{ item.name }}"
        scope: local
        value: "{{ item.value }}"
        repo: "{{ local_git_repo_dir }}"
      delegate_to: localhost
      loop:
        - { name: "user.name", value: "{{ git_user_name }}" }
        - { name: "user.email", value: "{{ git_user_email }}" }
      tags: ['git']

    - name: ç¡®ä¿Gitä»“åº“ä¸­çš„ä¸»æœºç›®å½•å­˜åœ¨
      file:
        path: "{{ local_git_repo_dir }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      tags: ['git']

    - name: åŒæ­¥å¤‡ä»½æ–‡ä»¶åˆ°Gitä»“åº“
      synchronize:
        src: "{{ local_extract_path }}/conf/"
        dest: "{{ local_git_repo_dir }}/{{ inventory_hostname }}/"
        delete: yes
        recursive: yes
      delegate_to: localhost
      tags: ['git']

    - name: åˆ›å»ºå¤‡ä»½å…ƒæ•°æ®æ–‡ä»¶
      copy:
        content: |
          # Apacheé…ç½®å¤‡ä»½å…ƒæ•°æ®
          å¤‡ä»½æ—¶é—´: {{ ansible_date_time.iso8601 }}
          æºä¸»æœº: {{ inventory_hostname }}
          æºIP: {{ ansible_host }}
          å¤‡ä»½ç”¨æˆ·: {{ ansible_user }}
          ç³»ç»Ÿä¿¡æ¯: {{ ansible_os_family }} {{ ansible_distribution_version }}
          å¤‡ä»½æ–‡ä»¶: {{ zip_filename }}
          æ–‡ä»¶å¤§å°: {{ zip_file_stat.stat.size }} bytes
          Ansibleç‰ˆæœ¬: {{ ansible_version.full }}
          æ‰§è¡Œæ–¹å¼: æœ¬åœ°Gitæ“ä½œ
          Gitåˆ†æ”¯: {{ github_branch | default('main') }}
        dest: "{{ local_git_repo_dir }}/{{ inventory_hostname }}/backup_metadata.txt"
      delegate_to: localhost
      tags: ['git', 'metadata']

    - name: æ£€æŸ¥Gitä»“åº“æ˜¯å¦æœ‰å˜æ›´
      shell: |
        cd "{{ local_git_repo_dir }}"
        git add .
        git diff --cached --name-only
      register: git_changes
      delegate_to: localhost
      changed_when: false
      tags: ['git']

    - name: æäº¤å˜æ›´åˆ°Gitä»“åº“
      shell: |
        cd "{{ local_git_repo_dir }}"
        git add .
        git commit -m "è‡ªåŠ¨å¤‡ä»½Apacheé…ç½® - {{ inventory_hostname }} - {{ ansible_date_time.iso8601 }}"
      delegate_to: localhost
      when: git_changes.stdout_lines | length > 0
      register: git_commit
      tags: ['git']

    - name: æ¨é€å˜æ›´åˆ°GitHub
      shell: |
        cd "{{ local_git_repo_dir }}"
        git push origin {{ github_branch | default('main') }}
      delegate_to: localhost
      when: git_commit is changed
      environment:
        GIT_TERMINAL_PROMPT: '0'
      no_log: true  # éšè—åŒ…å«tokençš„è¾“å‡º
      tags: ['git']

  post_tasks:
    - name: æ˜¾ç¤ºä»»åŠ¡å®Œæˆä¿¡æ¯
      debug:
        msg: |
          âœ… å¤‡ä»½å’ŒGitæ¨é€ä»»åŠ¡å®Œæˆï¼
          ğŸ“‹ æ‘˜è¦ä¿¡æ¯:
          - ä¸»æœº: {{ inventory_hostname }} ({{ ansible_host }})
          - å¤‡ä»½æ–‡ä»¶: {{ zip_filename }}
          - æœ¬åœ°è§£å‹è·¯å¾„: {{ local_extract_path }}
          - Gitä»“åº“è·¯å¾„: {{ local_git_repo_dir }}
          - GitHubä»“åº“: {{ github_repo }}
          - Gitåˆ†æ”¯: {{ github_branch | default('main') }}
          - å¤‡ä»½æ—¶é—´: {{ ansible_date_time.iso8601 }}
          - æ–‡ä»¶æ•°é‡: {{ extracted_files.matched }}
          {% if git_changes.stdout_lines | length > 0 %}
          - Gitå˜æ›´: {{ git_changes.stdout_lines | length }} ä¸ªæ–‡ä»¶
          - Gitæ¨é€: âœ… æˆåŠŸ
          {% else %}
          - Gitå˜æ›´: æ— å˜æ›´ï¼Œè·³è¿‡æ¨é€
          {% endif %}
          
          ğŸ“ æ–‡ä»¶ä½ç½®:
          - æœ¬åœ°ZIP: {{ local_zip_path }}
          - è§£å‹ç›®å½•: {{ local_extract_path }}
          - Gitä»“åº“: {{ local_git_repo_dir }}

    - name: æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
      file:
        path: "{{ item }}"
        state: absent
      delegate_to: localhost
      loop:
        - "{{ local_zip_path }}"
        # - "{{ local_extract_path }}"  # ä¿ç•™è§£å‹æ–‡ä»¶ä»¥ä¾›æ£€æŸ¥
        # - "{{ local_git_work_dir }}"  # ä¿ç•™Gitå·¥ä½œç›®å½•ä»¥ä¾›æ£€æŸ¥
      when: cleanup_temp_files | default(false) | bool
      tags: ['cleanup']

  handlers:
    - name: æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ backup_dir }}/{{ zip_filename }}"
        - "{{ local_zip_path }}"
      listen: "cleanup on failure"
      ignore_errors: yes 