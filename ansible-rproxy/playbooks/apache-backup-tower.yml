---
- name: Apacheé…ç½®æ–‡ä»¶å¤‡ä»½ (Ansible Towerä¼˜åŒ–ç‰ˆ)
  hosts: rproxy
  gather_facts: yes
  become: yes
  
  vars:
    # Towerå‹å¥½çš„å˜é‡å®šä¹‰
    timestamp: "{{ ansible_date_time.epoch }}"
    zip_filename: "apache-conf-{{ inventory_hostname }}-{{ timestamp }}.zip"
    # Toweræ‰§è¡Œç¯å¢ƒä¸­çš„è·¯å¾„
    local_zip_path: "/tmp/{{ zip_filename }}"
    local_extract_path: "/tmp/extracted/{{ inventory_hostname }}"
    
  pre_tasks:
    - name: éªŒè¯å¿…è¦å˜é‡æ˜¯å¦å·²å®šä¹‰
      assert:
        that:
          - github_repo is defined
          - github_token is defined
          - backup_dir is defined
        fail_msg: "å¿…è¦çš„å˜é‡æœªå®šä¹‰ï¼Œè¯·åœ¨Towerä¸­é…ç½®: github_repo, github_token, backup_dir"

    - name: æ˜¾ç¤ºä»»åŠ¡å¼€å§‹ä¿¡æ¯
      debug:
        msg: |
          ğŸš€ å¼€å§‹Apacheé…ç½®å¤‡ä»½ä»»åŠ¡
          - ç›®æ ‡ä¸»æœº: {{ inventory_hostname }} ({{ ansible_host }})
          - å¤‡ä»½ç›®å½•: {{ backup_dir }}
          - GitHubä»“åº“: {{ github_repo }}
          - ç›®æ ‡åˆ†æ”¯: {{ github_branch | default('main') }}

  tasks:
    - name: æ£€æŸ¥è¿œç¨‹httpdé…ç½®ç›®å½•
      stat:
        path: /etc/httpd/conf
      register: httpd_conf_dir
      tags: ['validation']

    - name: éªŒè¯Apacheé…ç½®ç›®å½•å­˜åœ¨
      assert:
        that:
          - httpd_conf_dir.stat.exists
          - httpd_conf_dir.stat.isdir
        fail_msg: "Apache httpdé…ç½®ç›®å½• /etc/httpd/conf ä¸å­˜åœ¨æˆ–ä¸æ˜¯ç›®å½•"
      tags: ['validation']

    - name: æ£€æŸ¥SELinuxçŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      command: getenforce
      register: selinux_status
      failed_when: false
      changed_when: false
      tags: ['system-info']

    - name: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
      debug:
        msg: |
          ğŸ“Š ç³»ç»Ÿä¿¡æ¯:
          - OS: {{ ansible_os_family }} {{ ansible_distribution_version }}
          - SELinux: {{ selinux_status.stdout | default('æœªå¯ç”¨') }}
          - Python: {{ ansible_python_version }}
      tags: ['system-info']

    - name: ç¡®ä¿è¿œç¨‹å¤‡ä»½ç›®å½•å­˜åœ¨
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      tags: ['preparation']

    - name: å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…
      package:
        name: 
          - zip
          - unzip
        state: present
      tags: ['preparation']

    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      shell: df -h {{ backup_dir }} | tail -1 | awk '{print $4}'
      register: available_space
      changed_when: false
      tags: ['validation']

    - name: æ˜¾ç¤ºå¯ç”¨ç£ç›˜ç©ºé—´
      debug:
        msg: "ğŸ“ å¤‡ä»½ç›®å½•å¯ç”¨ç©ºé—´: {{ available_space.stdout }}"
      tags: ['validation']

    - name: åˆ›å»ºApacheé…ç½®æ–‡ä»¶çš„zipåŒ…
      archive:
        path: /etc/httpd/conf
        dest: "{{ backup_dir }}/{{ zip_filename }}"
        format: zip
        mode: '0644'
        owner: root
        group: root
      register: zip_result
      tags: ['backup']

    - name: éªŒè¯zipæ–‡ä»¶åˆ›å»ºæˆåŠŸ
      stat:
        path: "{{ backup_dir }}/{{ zip_filename }}"
      register: zip_file_stat
      tags: ['validation']

    - name: ç¡®ä¿zipæ–‡ä»¶åˆ›å»ºæˆåŠŸ
      assert:
        that:
          - zip_file_stat.stat.exists
          - zip_file_stat.stat.size > 0
        fail_msg: "ZIPæ–‡ä»¶åˆ›å»ºå¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©º: {{ backup_dir }}/{{ zip_filename }}"
      tags: ['validation']

    - name: æ˜¾ç¤ºzipæ–‡ä»¶ä¿¡æ¯
      debug:
        msg: |
          ğŸ“¦ å¤‡ä»½æ–‡ä»¶ä¿¡æ¯:
          - æ–‡ä»¶è·¯å¾„: {{ backup_dir }}/{{ zip_filename }}
          - æ–‡ä»¶å¤§å°: {{ zip_file_stat.stat.size }} bytes
          - åˆ›å»ºæ—¶é—´: {{ zip_file_stat.stat.mtime }}
      tags: ['backup']

    - name: ä¸‹è½½zipæ–‡ä»¶åˆ°Toweræ‰§è¡ŒèŠ‚ç‚¹
      fetch:
        src: "{{ backup_dir }}/{{ zip_filename }}"
        dest: "{{ local_zip_path }}"
        flat: yes
        validate_checksum: yes
      register: fetch_result
      tags: ['download']

    - name: éªŒè¯æ–‡ä»¶ä¸‹è½½æˆåŠŸ
      stat:
        path: "{{ local_zip_path }}"
      register: local_zip_stat
      delegate_to: localhost
      tags: ['validation']

    - name: ç¡®ä¿æœ¬åœ°æ–‡ä»¶ä¸‹è½½æˆåŠŸ
      assert:
        that:
          - local_zip_stat.stat.exists
          - local_zip_stat.stat.size > 0
        fail_msg: "æœ¬åœ°ZIPæ–‡ä»¶ä¸‹è½½å¤±è´¥: {{ local_zip_path }}"
      delegate_to: localhost
      tags: ['validation']

    - name: æ¸…ç†è¿œç¨‹ä¸´æ—¶æ–‡ä»¶
      file:
        path: "{{ backup_dir }}/{{ zip_filename }}"
        state: absent
      tags: ['cleanup']

    - name: ç¡®ä¿æœ¬åœ°è§£å‹ç›®å½•å­˜åœ¨
      file:
        path: "{{ local_extract_path }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      tags: ['preparation']

    - name: è§£å‹zipæ–‡ä»¶åˆ°æœ¬åœ°ç›®å½•
      unarchive:
        src: "{{ local_zip_path }}"
        dest: "{{ local_extract_path }}"
        remote_src: no
      delegate_to: localhost
      tags: ['extract']

    - name: éªŒè¯è§£å‹æˆåŠŸ
      find:
        paths: "{{ local_extract_path }}"
        recurse: yes
      register: extracted_files
      delegate_to: localhost
      tags: ['validation']

    - name: ç¡®ä¿è§£å‹æˆåŠŸ
      assert:
        that:
          - extracted_files.matched > 0
        fail_msg: "æ–‡ä»¶è§£å‹å¤±è´¥ï¼Œæ²¡æœ‰æ‰¾åˆ°è§£å‹çš„æ–‡ä»¶"
      delegate_to: localhost
      tags: ['validation']

    - name: æ˜¾ç¤ºè§£å‹ä¿¡æ¯
      debug:
        msg: |
          ğŸ“‚ è§£å‹ä¿¡æ¯:
          - è§£å‹è·¯å¾„: {{ local_extract_path }}
          - æ–‡ä»¶æ•°é‡: {{ extracted_files.matched }}
      delegate_to: localhost
      tags: ['extract']

  post_tasks:
    - name: åˆ›å»ºå¤‡ä»½å…ƒæ•°æ®
      copy:
        content: |
          # Apacheé…ç½®å¤‡ä»½å…ƒæ•°æ®
          å¤‡ä»½æ—¶é—´: {{ ansible_date_time.iso8601 }}
          æºä¸»æœº: {{ inventory_hostname }}
          æºIP: {{ ansible_host }}
          å¤‡ä»½ç”¨æˆ·: {{ ansible_user }}
          ç³»ç»Ÿä¿¡æ¯: {{ ansible_os_family }} {{ ansible_distribution_version }}
          å¤‡ä»½æ–‡ä»¶: {{ zip_filename }}
          æ–‡ä»¶å¤§å°: {{ zip_file_stat.stat.size }} bytes
          Ansibleç‰ˆæœ¬: {{ ansible_version.full }}
          Towerä»»åŠ¡ID: {{ tower_job_id | default('N/A') }}
        dest: "{{ local_extract_path }}/backup_metadata.txt"
      delegate_to: localhost
      tags: ['metadata']

    - name: æ˜¾ç¤ºä»»åŠ¡å®Œæˆä¿¡æ¯
      debug:
        msg: |
          âœ… å¤‡ä»½ä»»åŠ¡å®Œæˆï¼
          ğŸ“‹ æ‘˜è¦ä¿¡æ¯:
          - ä¸»æœº: {{ inventory_hostname }} ({{ ansible_host }})
          - å¤‡ä»½æ–‡ä»¶: {{ zip_filename }}
          - æœ¬åœ°è·¯å¾„: {{ local_extract_path }}
          - GitHubåˆ†æ”¯: {{ github_branch | default('main') }}
          - å¤‡ä»½æ—¶é—´: {{ ansible_date_time.iso8601 }}
          - æ–‡ä»¶æ•°é‡: {{ extracted_files.matched }}
          
          ğŸ”„ ä¸‹ä¸€æ­¥: ä½¿ç”¨Towerçš„Gitæ¨é€åŠŸèƒ½æˆ–é…ç½®åç»­ä»»åŠ¡æ¨¡æ¿

    - name: æ¸…ç†æœ¬åœ°ä¸´æ—¶zipæ–‡ä»¶
      file:
        path: "{{ local_zip_path }}"
        state: absent
      delegate_to: localhost
      tags: ['cleanup']

  handlers:
    - name: æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ backup_dir }}/{{ zip_filename }}"
        - "{{ local_zip_path }}"
      listen: "cleanup on failure"
      ignore_errors: yes 